name: Canvas â†’ Trello Sync

"on":
  workflow_dispatch:
  schedule:
    # GitHub schedules are best-effort and may drift.
    - cron: "0 * * * *"

concurrency:
  group: canvas-trello-sync
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download previous state artifact (best effort)
        env:
          GH_TOKEN: ${{ github.token }}
          STATE_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          mkdir -p data
          state_path="data/canvas_trello_state.json"
          rm -f "${state_path}"

          # Restore the most recent run (any workflow) on this branch that uploaded the state artifact.
          # This avoids "state chain" breaks when the previous run failed or when the wipe workflow ran last.
          run_ids="$(
            gh api "repos/${GITHUB_REPOSITORY}/actions/runs?branch=${STATE_BRANCH}&status=completed&per_page=50" \
              --jq '.workflow_runs
                | map(select((.id|tostring) != env.GITHUB_RUN_ID))
                | .[].id'
          )"

          restored_from=""
          for run_id in ${run_ids}; do
            echo "Trying to restore state from run: ${run_id}"
            rm -f "${state_path}"
            if gh run download "${run_id}" --repo "${GITHUB_REPOSITORY}" -n canvas-trello-sync-state -D .; then
              if [ -f "${state_path}" ]; then
                restored_from="${run_id}"
                break
              fi
            fi
          done

          if [ -f "${state_path}" ]; then
            echo "State restored from run: ${restored_from}"
            python -c "import json; p='data/canvas_trello_state.json'; s=json.load(open(p,'r',encoding='utf-8')); print('state keys:', list(s.keys())); print('items:', len(s.get('item_to_card',{}) or {}), 'courses:', len(s.get('course_to_list',{}) or {}))"
          else
            echo "No previous state artifact found; starting with empty state."
          fi

      - name: Install dependencies
        run: |
          python --version
          python -m pip --version
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -c "import requests, dateutil, dotenv; print('deps: ok')"

      - name: Run sync once
        env:
          CANVAS_BASE_URL: ${{ secrets.CANVAS_BASE_URL }}
          CANVAS_TOKEN: ${{ secrets.CANVAS_TOKEN }}

          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}

          # Set ONE of these in secrets
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          TRELLO_BOARD_URL: ${{ secrets.TRELLO_BOARD_URL }}

          # Optional secrets/vars
          DUE_WITHIN_DAYS: ${{ secrets.DUE_WITHIN_DAYS }}
          CANVAS_TOKEN_CREATED_AT: ${{ secrets.CANVAS_TOKEN_CREATED_AT }}
          CANVAS_TOKEN_LIFETIME_DAYS: ${{ secrets.CANVAS_TOKEN_LIFETIME_DAYS }}
          POLL_INTERVAL_MINUTES: "60"
          SYNC_STATE_FILE: data/canvas_trello_state.json
          SYNC_ABORT_ON_MISSING_STATE: "1"
          SYNC_BOOTSTRAP_STATE_FROM_BOARD: "1"

          # Ensure `.env` (if present) doesn't override secrets.
          DOTENV_OVERRIDE: "0"
        run: |
          mkdir -p data logs
          : > logs/canvas_trello_sync.log
          python -m canvas_trello_sync --once --log-level INFO --log-file logs/canvas_trello_sync.log --log-http
          python -c "import json; p='data/canvas_trello_state.json'; s=json.load(open(p,'r',encoding='utf-8')); print('post-sync items:', len(s.get('item_to_card',{}) or {}))"

      - name: Upload state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canvas-trello-sync-state
          path: data/canvas_trello_state.json
          if-no-files-found: warn
          retention-days: 30

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canvas-trello-sync-logs
          path: logs/canvas_trello_sync.log
          if-no-files-found: warn
          retention-days: 7
