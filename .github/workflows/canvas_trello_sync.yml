name: Canvas â†’ Trello Sync

"on":
  workflow_dispatch:
  schedule:
    # GitHub schedules are best-effort and may drift.
    - cron: "0 * * * *"

concurrency:
  group: canvas-trello-sync
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download previous state artifact (best effort)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p data
          # Fetch the most recent *completed + successful* run (excluding the current run),
          # then download its state artifact.
          prev_run_id="$(
            gh api "repos/${GITHUB_REPOSITORY}/actions/workflows/canvas_trello_sync.yml/runs?branch=${GITHUB_REF_NAME}&status=completed&per_page=20" \
              --jq '.workflow_runs
                | map(select(.conclusion == "success"))
                | map(select((.id|tostring) != env.GITHUB_RUN_ID))
                | .[0].id // empty'
          )"
          if [ -n "${prev_run_id}" ]; then
            echo "Downloading previous state from run: ${prev_run_id}"
            gh run download "${prev_run_id}" -n canvas-trello-sync-state -D . || true
          else
            echo "No previous successful run found; starting with empty state."
          fi
          if [ -f data/canvas_trello_state.json ]; then
            echo "State file present: data/canvas_trello_state.json"
            python -c "import json; p='data/canvas_trello_state.json'; s=json.load(open(p,'r',encoding='utf-8')); print('state keys:', list(s.keys())); print('items:', len(s.get('item_to_card',{}) or {}), 'courses:', len(s.get('course_to_list',{}) or {}))"
          else
            echo "State file not present after download."
          fi

      - name: Install dependencies
        run: |
          python --version
          python -m pip --version
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -c "import requests, dateutil, dotenv; print('deps: ok')"

      - name: Run sync once
        env:
          CANVAS_BASE_URL: ${{ secrets.CANVAS_BASE_URL }}
          CANVAS_TOKEN: ${{ secrets.CANVAS_TOKEN }}

          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}

          # Set ONE of these in secrets
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          TRELLO_BOARD_URL: ${{ secrets.TRELLO_BOARD_URL }}

          # Optional secrets/vars
          DUE_WITHIN_DAYS: ${{ secrets.DUE_WITHIN_DAYS }}
          CANVAS_TOKEN_CREATED_AT: ${{ secrets.CANVAS_TOKEN_CREATED_AT }}
          CANVAS_TOKEN_LIFETIME_DAYS: ${{ secrets.CANVAS_TOKEN_LIFETIME_DAYS }}
          POLL_INTERVAL_MINUTES: "60"
          SYNC_STATE_FILE: data/canvas_trello_state.json

          # Ensure `.env` (if present) doesn't override secrets.
          DOTENV_OVERRIDE: "0"
        run: |
          mkdir -p data logs
          : > logs/canvas_trello_sync.log
          python -m canvas_trello_sync --once --log-level INFO --log-file logs/canvas_trello_sync.log --log-http
          python -c "import json; p='data/canvas_trello_state.json'; s=json.load(open(p,'r',encoding='utf-8')); print('post-sync items:', len(s.get('item_to_card',{}) or {}))"

      - name: Upload state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canvas-trello-sync-state
          path: data/canvas_trello_state.json
          if-no-files-found: warn
          retention-days: 30

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canvas-trello-sync-logs
          path: logs/canvas_trello_sync.log
          if-no-files-found: warn
          retention-days: 7
