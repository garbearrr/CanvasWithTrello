name: Canvas â†’ Trello Wipe (Managed)

"on":
  workflow_dispatch:
    inputs:
      board_id:
        description: "Resolved Trello board id (not URL). Required as a safety confirmation."
        required: true
        type: string
      full_wipe:
        description: "DANGEROUS: archive ALL open cards + lists before syncing (ignores state)."
        required: false
        type: boolean
        default: false

concurrency:
  group: canvas-trello-sync
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  wipe_and_sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download previous state artifact (best effort)
        env:
          GH_TOKEN: ${{ github.token }}
          STATE_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          mkdir -p data
          state_path="data/canvas_trello_state.json"
          rm -f "${state_path}"

          # Restore the most recent run (any workflow) on this branch that uploaded the state artifact.
          run_ids="$(
            gh api "repos/${GITHUB_REPOSITORY}/actions/runs?branch=${STATE_BRANCH}&status=completed&per_page=50" \
              --jq '.workflow_runs
                | map(select((.id|tostring) != env.GITHUB_RUN_ID))
                | .[].id'
          )"

          restored_from=""
          for run_id in ${run_ids}; do
            echo "Trying to restore state from run: ${run_id}"
            rm -f "${state_path}"
            if gh run download "${run_id}" --repo "${GITHUB_REPOSITORY}" -n canvas-trello-sync-state -D .; then
              if [ -f "${state_path}" ]; then
                restored_from="${run_id}"
                break
              fi
            fi
          done

          if [ -f "${state_path}" ]; then
            echo "State restored from run: ${restored_from}"
          else
            echo "No previous state artifact found; wipe will be limited without prior state."
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Validate board id (prints resolved id)
        env:
          CANVAS_BASE_URL: ${{ secrets.CANVAS_BASE_URL }}
          CANVAS_TOKEN: ${{ secrets.CANVAS_TOKEN }}
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          TRELLO_BOARD_URL: ${{ secrets.TRELLO_BOARD_URL }}
          SYNC_STATE_FILE: data/canvas_trello_state.json
          DOTENV_OVERRIDE: "0"
        run: python -m canvas_trello_sync --validate --log-level INFO

      - name: Wipe managed content then sync
        env:
          CANVAS_BASE_URL: ${{ secrets.CANVAS_BASE_URL }}
          CANVAS_TOKEN: ${{ secrets.CANVAS_TOKEN }}

          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}

          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          TRELLO_BOARD_URL: ${{ secrets.TRELLO_BOARD_URL }}

          DUE_WITHIN_DAYS: ${{ secrets.DUE_WITHIN_DAYS }}
          CANVAS_TOKEN_CREATED_AT: ${{ secrets.CANVAS_TOKEN_CREATED_AT }}
          CANVAS_TOKEN_LIFETIME_DAYS: ${{ secrets.CANVAS_TOKEN_LIFETIME_DAYS }}

          SYNC_STATE_FILE: data/canvas_trello_state.json
          SYNC_BOOTSTRAP_STATE_FROM_BOARD: "1"
          DOTENV_OVERRIDE: "0"
        run: |
          mkdir -p data logs
          : > logs/canvas_trello_sync.log
          wipe_flag="--wipe-board"
          if [ "${{ inputs.full_wipe }}" = "true" ]; then
            wipe_flag="--wipe-board-all"
          fi
          python -m canvas_trello_sync --once ${wipe_flag} --wipe-board-confirm "${{ inputs.board_id }}" --log-level INFO --log-file logs/canvas_trello_sync.log --log-http
          python -c "import json; p='data/canvas_trello_state.json'; s=json.load(open(p,'r',encoding='utf-8')); print('post-wipe-sync items:', len(s.get('item_to_card',{}) or {}), 'courses:', len(s.get('course_to_list',{}) or {}))"

      - name: Upload state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canvas-trello-sync-state
          path: data/canvas_trello_state.json
          if-no-files-found: warn
          retention-days: 30

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canvas-trello-sync-logs
          path: logs/canvas_trello_sync.log
          if-no-files-found: warn
          retention-days: 7
